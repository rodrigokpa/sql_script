CREATE FUNCTION [dbo].[fnProximaDataUtil] (
	@pData DATETIME,
	@pDiasAdd INT
)
RETURNS DATETIME
AS
BEGIN

	DECLARE @DIASADD_TRABALHO INT,
			@DIASADD_TRABALHO_AJUSTE INT,
			@DIASADD_TRABALHO_DESCONTO INT,
			@DIASADD_FERIADO INT,
			@DIASADD_AJUSTE_FERIADO INT,
			@NOVA_DATA DATETIME

	SET @DIASADD_TRABALHO = (DATEPART(DW,DATEADD(DAY,CASE DATEPART(DW,@pData) WHEN 7 THEN 2 WHEN 1 THEN 1 ELSE 0 END,@pData)) - 2 + @pDiasAdd) % 5
	SET @DIASADD_TRABALHO_AJUSTE = ((DATEPART(DW,DATEADD(DAY,CASE DATEPART(DW,@pData) WHEN 7 THEN 2 WHEN 1 THEN 1 ELSE 0 END,@pData)) - 2 + @pDiasAdd) / 5) * 7
	SET @DIASADD_TRABALHO_DESCONTO = (DATEPART(DW,DATEADD(DAY,CASE DATEPART(DW,@pData) WHEN 7 THEN 2 WHEN 1 THEN 1 ELSE 0 END,@pData)) - 2)

	SET @NOVA_DATA = DATEADD(DAY,CASE DATEPART(DW,@pData) WHEN 7 THEN 2 WHEN 1 THEN 1 ELSE 0 END ,@pData)	
		+ @DIASADD_TRABALHO
		+ @DIASADD_TRABALHO_AJUSTE
		- @DIASADD_TRABALHO_DESCONTO

	SET @DIASADD_AJUSTE_FERIADO = -1		

	SELECT	@DIASADD_FERIADO = COUNT(1)
	FROM	UOL_ASSINATURAS..AUX_FERIADO_NACIONAL 
	WHERE	STR(DATEPART(YEAR,@pData)) + '-' + MES + '-' + DIA BETWEEN @pData AND @NOVA_DATA
	SET @NOVA_DATA = DATEADD(DAY,CASE WHEN @DIASADD_FERIADO < 0 THEN 0 ELSE @DIASADD_FERIADO END,@NOVA_DATA)

	WHILE @DIASADD_AJUSTE_FERIADO <> 0
	BEGIN

		SELECT	@DIASADD_AJUSTE_FERIADO = COUNT(1)
		FROM	UOL_ASSINATURAS..AUX_FERIADO_NACIONAL 
		WHERE	MES = DATEPART(MONTH,@NOVA_DATA) AND
				DIA = DATEPART(DAY,@NOVA_DATA)

		SET @NOVA_DATA = DATEADD(DAY,@DIASADD_AJUSTE_FERIADO,@NOVA_DATA)

	END
		
	RETURN @NOVA_DATA

END
--
--
--select master.dbo.fnProximaDataUtil('2010-02-11',2)
