
CREATE PROCEDURE  [dbo].[SPR_LIMPA_OBJETOS_BD_AQUISICAO]  
AS  
  
--RODRIGO EDUARDO  
-- 12/06/2013
/*
	PROCESSO PARA LIMPEZA DE OBJETOS TEMPORARIOS E FORA DE USO DO BANCO AQUISIÇÃO
	PROCESSO INTERNO.
*/
  

--TRUNCA TABELA QUE SERÁ UTILIZADA PARA E-MAIL
    TRUNCATE TABLE TB_AQUISICAO_LIMPA_OBJETOS

--INSERE OS OBJETOS ATUAIS
	INSERT INTO TB_AQUISICAO_LIMPA_OBJETOS(NOME,TIPO)
	SELECT 
		NAME AS OBJETO,
		TYPE AS TIPO
	FROM 
		SYS.OBJECTS
	WHERE
		TYPE IN ('U','P')
		AND NAME LIKE'APAGAR_%'


--***** INICIO CURSOR
--AQUI DROPAMOS AS TABELAS UMA POR UMA

--DECLARA VARIAVEIS
		DECLARE @OBJETO VARCHAR(500)
		DECLARE @TIPO VARCHAR(1)

--INICIANDO O CURSOR
		DECLARE cr CURSOR FOR  
			SELECT 
				NAME AS OBJETO,
				TYPE AS TIPO
			FROM 
				SYS.OBJECTS
			WHERE
				TYPE IN ('U','P')
				AND NAME LIKE'APAGAR_%'
		OPEN cr   
			FETCH NEXT FROM cr INTO
				@OBJETO,@TIPO
		WHILE (@@FETCH_STATUS = 0)  
		--DROPA AS TABELAS	
			BEGIN 
				EXECUTE DROPOBJETO @OBJETO,@TIPO
			FETCH NEXT FROM cr INTO
				@OBJETO,@TIPO
			END
--FECHA O CURSOR
		CLOSE cr  
		DEALLOCATE cr  
--PRÓXIMO PASSO E-MAIL (OUTRA PROC)

