CREATE PROCEDURE DBO.SP_VERIFICA_LOG
AS
BEGIN

	SELECT	A.SESSION_ID SPID,
			D.TEXT SQLSTATEMENT,	
			ISNULL(B.STATUS,A.STATUS) STATUS,
			A.LOGIN_NAME,
			A.HOST_NAME,
			C.BLKBY,
			DB_NAME(B.DATABASE_ID) DBNAME,
			B.COMMAND,
			A.PROGRAM_NAME
	FROM	SYS.DM_EXEC_SESSIONS A (NOLOCK)
			LEFT JOIN SYS.DM_EXEC_REQUESTS B (NOLOCK)
			ON (A.SESSION_ID = B.SESSION_ID)
			LEFT JOIN (SELECT	A.REQUEST_SESSION_ID SPID,
								B.BLOCKING_SESSION_ID BLKBY
					   FROM		SYS.DM_TRAN_LOCKS A (NOLOCK)
								INNER JOIN SYS.DM_OS_WAITING_TASKS B (NOLOCK)
								ON (A.LOCK_OWNER_ADDRESS = B.RESOURCE_ADDRESS) ) C
			ON (A.SESSION_ID = C.SPID)
			OUTER APPLY SYS.DM_EXEC_SQL_TEXT(SQL_HANDLE) D
	WHERE	D.TEXT IS NOT NULL
			AND A.SESSION_ID != @@SPID

END


